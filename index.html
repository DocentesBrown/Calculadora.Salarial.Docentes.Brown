<!DOCTYPE html>
<html lang="es">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>Calculadora Salarial Docente</title>
 <style>
  :root {
   --azul-oscuro: #24496e;
   --morado: #4d3069;
   --celeste: #3d8fb0;
   --beige: #f3efdc;
   --rojo: #da6863;
  }

  body {
   font-family: sans-serif;
   background-color: var(--beige);
   color: var(--azul-oscuro);
   margin: 0;
   padding: 15px; /* Reducido el padding general */
  }

  h1 {
   text-align: center;
   color: var(--morado);
   font-size: 1.8em; /* Ajustado el tamaño del título */
   margin-bottom: 15px; /* Añadido margen inferior */
  }

  label {
   display: block;
   margin-top: 10px;
   font-weight: bold;
   font-size: 0.95em; /* Ajustado tamaño de la etiqueta */
  }

  input, select {
   width: calc(100% - 12px); /* Ajustado el ancho para el padding */
   padding: 6px; /* Reducido el padding de los campos */
   margin-top: 5px;
   box-sizing: border-box;
   border: 1px solid var(--celeste);
   border-radius: 5px;
   font-size: 0.9em; /* Ajustado tamaño del texto */
  }

  button {
   background-color: var(--morado);
   color: white;
   padding: 10px;
   border: none;
   border-radius: 5px;
   margin-top: 15px;
   cursor: pointer;
   width: 100%;
   font-size: 1em; /* Ajustado tamaño del texto del botón */
  }

  button:hover {
   background-color: var(--rojo);
  }

  .card {
   background-color: white;
   border: 1px solid var(--celeste);
   border-radius: 5px;
   padding: 10px;
   margin-top: 10px;
  }

  .note {
   font-size: 0.85em; /* Ajustado tamaño de la nota */
   color: #555;
   margin-top: 5px;
  }

  #resultDisplay {
   margin-top: 20px;
   font-size: 1.1em; /* Ajustado tamaño del resultado */
   font-weight: bold;
   color: var(--morado);
   text-align: center; /* Centrado el resultado */
  }

  #salaryBreakdown {
   margin-top: 15px;
   font-size: 0.9em; /* Ajustado tamaño del desglose */
  }

  #salaryBreakdown h3 {
   color: var(--azul-oscuro);
   margin-top: 10px;
   margin-bottom: 5px;
   font-size: 1em; /* Ajustado tamaño del título del desglose */
  }

  #salaryBreakdown ul {
   padding-left: 15px; /* Añadido padding a la lista */
   list-style: disc; /* Cambiado el estilo de la lista */
  }

  .warning {
   color: var(--rojo);
   font-weight: bold;
   margin-top: 5px;
   font-size: 0.9em; /* Ajustado tamaño de la advertencia */
  }

  .controls {
   display: flex;
   flex-direction: column;
   gap: 10px;
   margin-top: 20px;
  }

  .controls button {
   width: 100%;
  }

  #usageCounter {
   text-align: center;
   font-size: 0.8em;
   color: #777;
   margin-top: 10px;
  }

  @media (max-width: 600px) {
   h1 { font-size: 1.6em; }
  }
 </style>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
 <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

 <h1>Calculadora Salarial Docente</h1>

 <label for="monthSelect">Mes:</label>
 <select id="monthSelect"></select>
 <div id="basicSalaryDisplay"></div>

 <label for="positionCount">Cantidad de cargos:</label>
 <input type="number" id="positionCount" min="1" value="1">
 <div class="note">
  Si tienen módulos en diferentes niveles educativos, elija tantos cargos como niveles tengas, así podrá calcular cuánto cobras por tus módulos diferenciados por NIVEL.
 </div>

 <label for="globalAntig">Antigüedad en años (aplicada a cada cargo):</label>
 <input type="number" id="globalAntig" min="0" placeholder="Ej: 10">

 <div id="cardsContainer"></div>

 <button id="calculateBtn">CALCULAR SALARIO</button>
 <div id="usageCounter"></div>

 <div id="resultDisplay"></div>
 <div id="salaryBreakdown"></div>

 <div class="controls">
  <button id="exportPdfBtn">Exportar a PDF</button>
  <button id="shareBtn">Compartir Aplicación</button>
 </div>

 <script>
  const sheetId = '1UVE9egJbF5SnN14h1s7qJPyvYAKcy8rynyOAfNO3jWo';
  const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

  const basicMap = {};
  let cargosList = new Set();
  let desfavList = new Set();

  const monthSelect = document.getElementById('monthSelect');
  const basicDisplay = document.getElementById('basicSalaryDisplay');
  const positionCount = document.getElementById('positionCount');
  const cardsContainer = document.getElementById('cardsContainer');
  const calculateBtn = document.getElementById('calculateBtn');
  const resultDisplay = document.getElementById('resultDisplay');
  const salaryBreakdown = document.getElementById('salaryBreakdown');
  const globalAntig = document.getElementById('globalAntig');
  const exportPdfBtn = document.getElementById('exportPdfBtn');
  const shareBtn = document.getElementById('shareBtn');
  const usageCounter = document.getElementById('usageCounter');

  const antiguedadMap = {
   0: 0.21, 1: 0.21, 2: 0.24, 3: 0.24, 4: 0.33, 5: 0.33, 6: 0.33,
   7: 0.43, 8: 0.43, 9: 0.43, 10: 0.54, 11: 0.54, 12: 0.64, 13: 0.64,
   14: 0.64, 15: 0.74, 16: 0.74, 17: 0.84, 18: 0.84, 19: 0.84,
   20: 1.05, 21: 1.05, 22: 1.15, 23: 1.15, "mas de 24": 1.24
  };

  const desfavMap = {
   0: 0, 1: 0.30, 2: 0.60, 3: 0.90, 4: 1.00, 5: 1.20
  };

  const indicesBasico = {
   'Maestro de Grado': 1.1,
   'Maestro de Inicial': 1.1,
   'Preceptor (Inicial)': 1,
   'Preceptor (Sec/Sup)': 1,
   'Profesor Módulos Secundaria': 0.1,
   'Profesor Módulos Inicial': 0.06666666667,
   'Profesor Módulos Primaria': 0.08333333333,
   'Profesor Módulos Superior': 0.125,
   'Bibliotecario Inicial & Primaria': 1.1,
   'Bibliotecario Secundaria & Superior': 1.2,
   'EMATP': 1.2,
   'Maestro Especial': 1.1
  };

  let calculateCount = localStorage.getItem('calculateCount') || 0;
  calculateCount = parseInt(calculateCount);
  usageCounter.innerText = `Calculos realizados: ${calculateCount}`;

  fetch(url)
   .then(response => response.text())
   .then(data => {
    const jsonText = data.substring(47).slice(0, -2);
    const jsonData = JSON.parse(jsonText);
    const rows = jsonData.table.rows;

    rows.forEach(row => {
     const cells = row.c;
     if (cells && cells.length > 0 && cells.length > 1) {
      if (cells.length > 0 && cells [0].v) {
       const mes = cells [0].v;
       monthSelect.appendChild(new Option(mes, mes));
       const basico = cells.length > 1 && cells [1].v ? Number(cells [1].v) : 0;
       basicMap [mes] = basico;
      }
      if (cells.length > 2 && cells [2].v) cargosList.add(cells [2].v);
      if (cells.length > 3 && cells [3].v) desfavList.add(cells [3].v);
     }
    });

    updateCards();

    monthSelect.addEventListener('change', () => {
     const sel = monthSelect.value;
     const bas = basicMap [sel] || 0;
     basicDisplay.innerText = `Salario básico: $${bas.toFixed(2)}`;
    });
   });

  positionCount.addEventListener('input', updateCards);

  function updateCards() {
   cardsContainer.innerHTML = '';
   const count = parseInt(positionCount.value) || 0;
   for (let i = 0; i < count; i++) {
    const card = document.createElement('div');
    card.className = 'card';

    const labelCargo = document.createElement('label');
    labelCargo.textContent = 'Cargo ' + (i + 1) + ':';
    const selectCargo = document.createElement('select');
    selectCargo.id = 'cargo' + i;
    cargosList.forEach(cargo => {
     selectCargo.appendChild(new Option(cargo, cargo));
    });

    const labelDesf = document.createElement('label');
    labelDesf.textContent = 'Desfavorabilidad:';
    const selectDesf = document.createElement('select');
    selectDesf.id = 'desf' + i;
    for (let j = 0; j <= 5; j++) {
     selectDesf.appendChild(new Option(j, j));
    }

    const modulosLabel = document.createElement('label');
    modulosLabel.textContent = 'Cantidad de módulos:';
    const modulosInput = document.createElement('input');
    modulosInput.type = 'number';
    modulosInput.id = 'modulos' + i;
    modulosInput.placeholder = 'Ej: 7';
    modulosInput.min = 0;

    card.appendChild(labelCargo);
    card.appendChild(selectCargo);
    card.appendChild(labelDesf);
    card.appendChild(selectDesf);
    card.appendChild(modulosLabel);
    card.appendChild(modulosInput);

    cardsContainer.appendChild(card);
   }
  }

  calculateBtn.addEventListener('click', () => {
   calculateCount++;
   localStorage.setItem('calculateCount', calculateCount);
   usageCounter.innerText = `Calculos realizados: ${calculateCount}`;

   const selMes = monthSelect.value;
   const basico = basicMap [selMes] || 0;
   salaryBreakdown.innerHTML = '';
   let total = 0;
   let breakdownHTML = '<h3>Detalle del sueldo</h3><ul>';

   const antig = globalAntig.value;
   const antigPorcentaje = antiguedadMap [antig] || 0;

   const count = parseInt(positionCount.value) || 0;

   // Variables para controlar los topes globales de módulos
   let totalAdicional455 = 0;
   let totalAdicional667 = 0;
   const maxAdicional455 = 204596;
   const maxAdicional667 = 199185.86;

   for (let i = 0; i < count; i++) {
    const cargo = document.getElementById('cargo' + i).value;
    const desf = parseInt(document.getElementById('desf' + i).value) || 0;
    const modulos = parseInt(document.getElementById('modulos' + i).value) || 0;

    breakdownHTML += `<li><strong>Cargo ${i + 1} - ${cargo}</strong></li>`;

    let subtotal = 0;
    let detalle = '';
    let basicoCargo = basico * (indicesBasico [cargo] || 1);

    if (['Maestro de Grado', 'Maestro de Inicial', 'Bibliotecario Inicial & Primaria'].includes(cargo)) {
     subtotal = basicoCargo + 168929.78 + 102298 + 154038 + 399.56;
     detalle += `
       <li>0110 Básico: $${basicoCargo.toFixed(2)}</li>
       <li>0641 Bonificación 1º y 2º ciclo: $168929.78</li>
       <li>0455 Bonificación Docente Agosto 2008: $102298</li>
       <li>0438 Bonificación remunerativa: $154038</li>
       <li>2761 Garantía sin aportes: $399.56</li>
      `;
    } else if (['Bibliotecario Secundaria & Superior', 'EMATP'].includes(cargo)) {
     subtotal = basicoCargo + 102298 + 99592.93 + 187839.83 + 450.14;
     detalle += `
       <li>0110 Básico: $${basicoCargo.toFixed(2)}</li>
       <li>0455 Bonificación Docente Agosto 2008: $102298</li>
       <li>0667 Bonificación Hs/Mod. Media: $99592.93</li>
       <li>0451 Suma No Bonificable: $187839.83</li>
       <li>2761 Garantía sin aportes: $450.14</li>
      `;
    } else if (cargo === 'Maestro Especial') {
     subtotal = basicoCargo + 196664.52 + 50426.80 + 102298 + 154038;
     detalle += `
       <li>0110 Básico: $${basicoCargo.toFixed(2)}</li>
       <li>0623 Plus Enseñanza: $196664.52</li>
       <li>0640 Bonificación Función Especial: $50426.80</li>
       <li>0455 Bonif. Docente agosto 2008: $102298.00</li>
       <li>0438 Bonificación remunerativa no bonificante: $154038.00</li>
      `;
    } else if (cargo === 'Preceptor (Inicial)') {
     subtotal = basicoCargo + 168929.78 + 102298 + 412.20;
     detalle += `
       <li>0110 Básico: $${basicoCargo.toFixed(2)}</li>
       <li>0623 Plus Enseñanza: $168929.78</li>
       <li>0455 Bonif. Docente agosto 2008: $102298.00</li>
       <li>2761 Garantía Sin aportes: $412.20</li>
      `;
    } else if (cargo === 'Preceptor (Sec/Sup)') {
     subtotal = basicoCargo + 42.94 + 230072.28 + 102298 + 507.54;
     detalle += `
       <li>0110 Básico: $${basicoCargo.toFixed(2)}</li>
       <li>0648 Garantía con aportes 730: $42.94</li>
       <li>0653 Bonificación PR: $230072.28</li>
       <li>0455 Bonif. Docente agosto 2008: $102298.00</li>
       <li>2761 Garantía Sin aportes 930: $507.54</li>
      `;
    } else if (cargo.includes('Módulos')) {
     const valorModulo = basicoCargo;
     basicoCargo = valorModulo * modulos;

     // Calculamos los adicionales proporcionales
     const proporcional455 = valorModulo * modulos * 0.4057;
     const proporcional667 = valorModulo * modulos * 0.395;

     // Aplicamos los topes de manera acumulativa
     const disponible455 = maxAdicional455 - totalAdicional455;
     const disponible667 = maxAdicional667 - totalAdicional667;

     const adicional455 = Math.min(proporcional455, disponible455);
     const adicional667 = Math.min(proporcional667, disponible667);

     totalAdicional455 += adicional455;
     totalAdicional667 += adicional667;

     // Calculamos antigüedad y desfavorabilidad sobre el básico del módulo
     const adicionalDesf = valorModulo * (desfavMap [desf] || 0) * modulos;
     const adicionalAntig = valorModulo * (antiguedadMap [antig] || 0) * modulos;

     subtotal = basicoCargo + adicional667 + adicional455 + adicionalDesf + adicionalAntig;

     detalle += `
       <li>Valor por módulo: $${valorModulo.toFixed(2)}</li>
       <li>Módulos: ${modulos} × $${valorModulo.toFixed(2)} = $${basicoCargo.toFixed(2)}</li>
       <li>667 Bonificación No Jerárquica (39.5%): $${adicional667.toFixed(2)}</li>
       <li>455 Bonif. Docente agosto 2008 (40.57%): $${adicional455.toFixed(2)}</li>
       <li>Adicional desfavorabilidad: $<span class="math-inline">\{adicionalDesf\.toFixed\(2\)\}</li\>
<li\>Antigüedad \(</span>{antig} años): $${adicionalAntig.toFixed(2)}</li>
      `;

     // Advertencia si se aplicó tope
     if (proporcional455 > disponible455 || proporcional667 > disponible667) {
      detalle += `<li class="warning">¡ATENCIÓN! Se aplicó tope máximo global para este cargo</li>`;
     }
    } else {
     subtotal = basicoCargo;
     detalle += `<li>Salario básico ajustado: $${subtotal.toFixed(2)}</li>`;
    }

    // Para cargos que no son módulos, calculamos antigüedad y desfavorabilidad normal
    if (!cargo.includes('Módulos')) {
     const adicionalDesf = basico * (desfavMap [desf] || 0);
     subtotal += adicionalDesf;
     detalle += `<li>Adicional desfavorabilidad: $${adicionalDesf.toFixed(2)}</li>`;

     const adicionalAntig = basicoCargo * antigPorcentaje;
     subtotal += adicionalAntig;
     detalle += `<li>Antigüedad (${antig} años): $${adicionalAntig.toFixed(2)}</li>`;
    }

    breakdownHTML += detalle;
    total += subtotal;
   }

   const descuentoIPS = total * 0.16;
   const descuentoIOMA = total * 0.048;
   const salarioBolsi = total - descuentoIPS - descuentoIOMA;

   breakdownHTML += `
     </ul>
     <h3>Resumen de adicionales para módulos</h3>
     <ul>
      <li>Total 455 Bonif. Docente: $${totalAdicional455.toFixed(2)} / $${maxAdicional455.toFixed(2)}</li>
      <li>Total 667 Bonif. No Jerárquica: $${totalAdicional667.toFixed(2)} / <span class="math-block">\{maxAdicional667\.toFixed\(2\)\}</li\>
</ul\>
<h3\>Descuentos</h3\>
<ul\>
<li\>IPS \(16%\)\: \-</span>{descuentoIPS.toFixed(2)}</li>
      <li>IOMA (4.8%): -$${descuentoIOMA.toFixed(2)}</li>
     </ul>
    `;

   resultDisplay.innerHTML = `
     <div>Salario total estimado: <strong><span class="math-block">\{total\.toFixed\(2\)\}</strong\></div\>
<div\>Salario de bolsillo\: <strong\></span>{salarioBolsi.toFixed(2)}</strong></div>
    `;
   salaryBreakdown.innerHTML = breakdownHTML;
  });

  exportPdfBtn.addEventListener('click', () => {
   const doc = new jspdf.jsPDF();
   const imageUrl = 'https://drive.google.com/file/d/1NkNNP4xNp894gWEmeSaB0tFuaHQItD-S/view?usp=drive_link';

   // Función para obtener la imagen como base64 (necesario para jsPDF)
   function getBase64Image(url, callback) {
    const img = new Image();
    img.setAttribute('crossOrigin', 'anonymous');
    img.onload = () => {
     const canvas = document.createElement('canvas');
     canvas.width = img.width;
     canvas.height = img.height;
     const ctx = canvas.getContext('2d');
     ctx.drawImage(img, 0, 0);
     const dataURL = canvas.toDataURL('image/png');
     callback(dataURL);
    };
    img.onerror = () => {
     console.error('Error al cargar la imagen');
     callback(null);
    };
    img.src = url;
   }

   getBase64Image(imageUrl, (base64Data) => {
    if (base64Data) {
     const imgProps = doc.getImageProperties(base64Data);
     const pdfWidth = doc.internal.pageSize.getWidth();
     const pdfHeight = doc.internal.pageSize.getHeight();

     // Calcular la posición y tamaño para la marca de agua (centrada y con tamaño proporcional)
     const imgWidth = pdfWidth * 0.5;
     const imgHeight = (imgWidth * imgProps.height) / imgProps.width;
     const x = (pdfWidth - imgWidth) / 2;
     const y = (pdfHeight - imgHeight) / 2;

     doc.addImage(base64Data, 'PNG', x, y, imgWidth, imgHeight, 'watermark', 'F');

     doc.setFontSize(18);
     doc.setTextColor(77, 48, 105); // Color morado
     doc.text('Recibo de Sueldo Estimado', pdfWidth / 2, 20, { align: 'center' });

     let yPosition = 40;
     const lineHeight = 10;
     doc.setFontSize(12);
     doc.setTextColor(0);

     const month = document.getElementById('monthSelect').value;
     doc.text(`Mes: ${month}`, 15, yPosition);
     yPosition += lineHeight;

     const basicSalaryText = document.getElementById('basicSalaryDisplay').innerText;
     doc.text(basicSalaryText, 15, yPosition);
     yPosition += lineHeight;

     const resultText = document.getElementById('resultDisplay').innerText.replace('Salario total estimado: ', 'Total estimado: ').replace('Salario de bolsillo: ', 'De bolsillo: ');
     const resultLines = doc.splitTextToSize(resultText, pdfWidth - 30);
     resultLines.forEach(line => {
      doc.text(line, 15, yPosition);
      yPosition += lineHeight;
     });
     yPosition += 5;

     const breakdownTitle = document.querySelector('#salaryBreakdown h3:first-child');
     if (breakdownTitle) {
      doc.setFontSize(14);
      doc.setTextColor(36, 73, 110); // Color azul oscuro
      doc.text(breakdownTitle.innerText, 15, yPosition);
      yPosition += lineHeight;
      doc.setFontSize(12);
      doc.setTextColor(0);
      const breakdownList = document.querySelector('#salaryBreakdown ul:first-child');
      if (breakdownList) {
       const items = breakdownList.querySelectorAll('li');
       items.forEach(item => {
        const lines = doc.splitTextToSize(item.innerText, pdfWidth - 30);
        lines.forEach(line => {
         doc.text(line, 20, yPosition);
         yPosition += lineHeight;
        });
       });
       yPosition += 5;
      }

      const additionalTitle = document.querySelector('#salaryBreakdown h3:nth-child(2)');
      if (additionalTitle) {
       doc.setFontSize(14);
       doc.setTextColor(36, 73, 110);
       doc.text(additionalTitle.innerText, 15, yPosition);
       yPosition += lineHeight;
       doc.setFontSize(12);
       doc.setTextColor(0);
       const additionalList = document.querySelector('#salaryBreakdown ul:nth-child(2)');
       if (additionalList) {
        const items = additionalList.querySelectorAll('li');
        items.forEach(item => {
         doc.text(item.innerText, 20, yPosition);
         yPosition += lineHeight;
        });
        yPosition += 5;
       }
      }

      const discountsTitle = document.querySelector('#salaryBreakdown h3:nth-child(3)');
      if (discountsTitle) {
       doc.setFontSize(14);
       doc.setTextColor(36, 73, 110);
       doc.text(discountsTitle.innerText, 15, yPosition);
       yPosition += lineHeight;
       doc.setFontSize(12);
       doc.setTextColor(0);
       const discountsList = document.querySelector('#salaryBreakdown ul:nth-child(3)');
       if (discountsList) {
        const items = discountsList.querySelectorAll('li');
        items.forEach(item => {
         doc.text(item.innerText, 20, yPosition);
         yPosition += lineHeight;
        });
       }
      }
     }

     doc.save('recibo_sueldo_estimado.pdf');
    }
   });
  });

  shareBtn.addEventListener('click', () => {
   if (navigator.share) {
    navigator.share({
     title: 'Calculadora Salarial Docente',
     text: 'Calcula tu salario docente de manera fácil y rápida.',
     url: window.location.href,
    })
    .then(() => console.log('Compartido exitosamente'))
    .catch((error) => console.log('Error al compartir', error));
   } else {
    alert('La función de compartir no está disponible en este navegador.');
   }
  });
 </script>
</body>
</html>
